name: CHEK CI/CD (prod tag -> GitOps)

on:
  pull_request:
    branches: [main, dev, staging]
  push:
    branches: [main, dev, staging]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: chek-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: chek-images-cn-beijing.cr.volces.com

jobs:
  security-gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          set -euo pipefail
          GITLEAKS_VERSION=8.18.4
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run gitleaks
        id: gitleaks
        continue-on-error: true
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE || '' }}
        run: |
          set -euo pipefail
          gitleaks detect \
            --source . \
            --no-git \
            --redact \
            --exit-code 1 \
            --report-format json \
            --report-path gitleaks-report.json

      - name: Fail if leaks found
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "Gitleaks found leaks. Please remove secrets from the repo." >&2
          exit 1

  security-trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy filesystem scan (HIGH/CRITICAL)
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          output: trivy-fs.txt
          exit-code: "1"
          vuln-type: os,library
          severity: HIGH,CRITICAL

      - name: Fail if HIGH/CRITICAL found
        if: steps.trivy.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities. Please upgrade deps or add a justified .trivyignore." >&2
          exit 1

  backend:
    needs: [security-gitleaks, security-trivy]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        svc:
          - name: backend-chek-content
            dir: backend-CHEK-content
          - name: backend-chek-media
            dir: backend-CHEK-media
          - name: backend-chek-ai
            dir: backend-CHEK-ai
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build & test (Maven)
        working-directory: ${{ matrix.svc.dir }}
        run: mvn -q -B test package

      - name: Login VECR (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build & push image (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: ${{ matrix.svc.dir }}
        env:
          IMAGE: ${{ env.REGISTRY }}/prod/${{ matrix.svc.name }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          docker build -t "$IMAGE:$TAG" .
          docker push "$IMAGE:$TAG"
          docker tag "$IMAGE:$TAG" "$IMAGE:prod"
          docker push "$IMAGE:prod"

      - name: Dispatch GitOps bump (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: chekdata/ops-bootstrap
          event-type: app-image-pushed
          client-payload: >-
            {"app":"${{ matrix.svc.name }}","image_repo":"${{ env.REGISTRY }}/prod/${{ matrix.svc.name }}","image_tag":"${{ github.ref_name }}","envs":"prod"}

  frontend:
    needs: [security-gitleaks, security-trivy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend-CHEK/package-lock.json

      - name: Install deps
        working-directory: frontend-CHEK
        run: npm ci

      - name: Build (Next.js)
        working-directory: frontend-CHEK
        run: npm run build

      - name: Login VECR (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build & push image (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: frontend-CHEK
        env:
          IMAGE: ${{ env.REGISTRY }}/prod/frontend-chek
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          docker build -t "$IMAGE:$TAG" .
          docker push "$IMAGE:$TAG"
          docker tag "$IMAGE:$TAG" "$IMAGE:prod"
          docker push "$IMAGE:prod"

      - name: Dispatch GitOps bump (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: chekdata/ops-bootstrap
          event-type: app-image-pushed
          client-payload: >-
            {"app":"frontend-chek","image_repo":"${{ env.REGISTRY }}/prod/frontend-chek","image_tag":"${{ github.ref_name }}","envs":"prod"}

  crawler:
    needs: [security-gitleaks, security-trivy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: backend-CHEK-crawler/package-lock.json

      - name: Install deps
        working-directory: backend-CHEK-crawler
        run: npm ci

      - name: Quick syntax check
        working-directory: backend-CHEK-crawler
        run: node -c src/main.mjs && node -c src/platform/weibo.mjs && node -c src/platform/xhs.mjs

      - name: Login VECR (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build & push image (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: backend-CHEK-crawler
        env:
          IMAGE: ${{ env.REGISTRY }}/prod/backend-chek-crawler
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          docker build -t "$IMAGE:$TAG" .
          docker push "$IMAGE:$TAG"
          docker tag "$IMAGE:$TAG" "$IMAGE:prod"
          docker push "$IMAGE:prod"

      - name: Dispatch GitOps bump (prod tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: chekdata/ops-bootstrap
          event-type: app-image-pushed
          client-payload: >-
            {"app":"backend-chek-crawler","image_repo":"${{ env.REGISTRY }}/prod/backend-chek-crawler","image_tag":"${{ github.ref_name }}","envs":"prod"}

